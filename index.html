<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            body {
                color: rgba(0, 0, 0, 0.8);
            }

            .style_div {
                margin: 5px;
                width: 150px;
                font-size: 16pt;
            }    

            .style_div input {
                background-color: inherit;
                border: none;
                outline: none;
                border-bottom: 1px black solid;
                font-size: 25pt;
                width: 140px;
                color: inherit;
            }

            .material-icons {
                font-family: 'Material Icons';
                font-weight: normal;
                font-style: normal;
                font-size: 24px;  /* Preferred icon size */
                display: inline-block;
                line-height: 1;
                text-transform: none;
                letter-spacing: normal;
                word-wrap: normal;
                white-space: nowrap;
                direction: ltr;

                /* Support for all WebKit browsers. */
                -webkit-font-smoothing: antialiased;
                /* Support for Safari and Chrome. */
                text-rendering: optimizeLegibility;

                /* Support for Firefox. */
                -moz-osx-font-smoothing: grayscale;

                /* Support for IE. */
                font-feature-settings: 'liga';
            }

            .material-icons.md-18 { font-size: 18px; }
            .material-icons.md-24 { font-size: 24px; }
            .material-icons.md-36 { font-size: 36px; }
            .material-icons.md-48 { font-size: 48px; }
            .material-icons.md-96 { font-size: 96px; }

            .pointer {
                cursor: pointer;
            }

            #timerDiv p {
                margin: 5px;
                font-size: 40pt;
                font-weight: 800;
            }

            #timerDiv {
                transition: max-height 0.2s ease-out;
            }

            #body {
                transition: background-color 0.2s ease-out;
            }

        </style>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    </head>
    <body style="background-color: #8fb4e0" id="body"> 

        <div style="position: fixed; bottom: 10px;  right: 10px;"> 
                <i id="startButton" class="material-icons md-96 pointer" onmousedown="go()">play_circle_filled</i>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: center; display: none; max-height: 100%" id="timerDiv">
                <p id="statusText">WORK IT!</p>
                <p id="timeLeft">01:15</p>
            </div>

        <div style="display: flex; flex-direction: column; align-items: center; height: 80%; justify-content: center;" id="settingsDiv">
            <div class="style_div"><span>Laps</span> <input id="laps" tpye="number" value="3"></div>
            <div class="style_div"><span>Exercises </span> <input id="exercises" type="number" value="3"></div>
            <div class="style_div"><span>Active (s)</span> <input id="activeTime" type="number" value = "30" ></div>
            <div class="style_div"><span>Pause (s)</span> <input id="pauseTime" type="number" value = "15"></div>
            <div class="style_div"><span>Ext. pause (s)</span> <input id="extendedPauseTime" type="number" value = "60"></div>
            <div class="style_div"><span>Volume</span><input id="volume" type="number" onchange="setVolume()" min="0" max="40" value="10"></div>
        </div>    


        <script>
            var orderList = [];

            var volume = 10;

            function setVolume() {
                volume = document.getElementById('volume').value;

                if (volume < 0) {
                    volume = 0;
                } else if (volume > 80) {
                    volume = 80;
                }

                document.getElementById('volume').value = volume;

                beep();
            }

            function pause() {
                orderList[0].pause();

                if (orderList[0].running) {
                    document.getElementById('startButton').innerHTML = "pause_circle_filled";
                    document.getElementById('timerDiv').style.maxHeight = '100%';
                } else {
                    document.getElementById('startButton').innerHTML = "play_circle_filled";
                    document.getElementById('timerDiv').style.maxHeight = '20%';
                }
            }

            function go() {
                buildOrderList();

                window.addEventListener("done", () =>  {
                    orderList.splice(0, 1);
                    if (orderList.length > 0) {
                        orderList[0].start();
                    }
                });
                
                orderList[0].start();
                
                document.getElementById('timerDiv').style.display = 'flex';
                document.getElementById('startButton').innerHTML = "pause_circle_filled";
                document.getElementById('startButton').onmousedown = pause;
            }

            function buildOrderList() {
                var laps = document.getElementById('laps').value;
                var exercises = document.getElementById('exercises').value;
                var activeTime = document.getElementById('activeTime').value;
                var pauseTime = document.getElementById('pauseTime').value;
                var extendedPauseTime = document.getElementById('extendedPauseTime').value;
                
                orderList.push(new Prepare(5));
                
                for (x = 0; x < laps; x += 1) {
                    for (y = 0; y < exercises; y += 1) {
                        orderList.push(new Active(activeTime));

                        if (y < exercises - 1) {
                            orderList.push(new Pause(pauseTime));
                        }

                    }
                    if (x <  laps - 1) {
                        orderList.push(new Pause(extendedPauseTime));
                    }
                }

            }


            class Timer {

                constructor (duration) {
                    this.duration = duration * 1000;

                    this.running = false;
                    this.timeoutLength = 1000;
                }

                start() {
                    this.running = true;
                    this.onStart();
                    this.onTimeout();
                    this.timeout();
                }

                timeout() {
                    setTimeout(() => {
                        if (this.running) {
                            this.duration -= this.timeoutLength;
                            if (this.duration <= 0)
                            {
                                this.onDone();
                                this.running = false;
                                this.onEnd();
                            } else {
                                this.onTimeout();
                                this.timeout();  
                            }
                        }
                    }, this.timeoutLength);
                }

                onStart() {
                    console.log("on start");
                }

                onTimeout() {
                    console.log("in timeout, duration left of timer: " + this.duration);
                }

                onDone() {
                    console.log("done");
                }

                pause() {
                    if (this.running) {
                        console.log("timer paused");
                        this.running = false;
                    } else {
                        console.log("timer started again");
                        this.running = true;
                        this.timeout();
                    }
                }

                onEnd() {
                    self.dispatchEvent(new CustomEvent("done"));
                }
            }

            class Active extends Timer {
                onTimeout() {
                    
                    document.getElementById('statusText').innerHTML = "WORK IT";
                    document.getElementById('timeLeft').innerHTML = secondsToPresentableString(this.duration / 1000);
                    if (this.duration <= 3000) {
                        beep();
                    }
                }

                onDone() {
                    document.getElementById('timeLeft').innerHTML = "Finished";
                    beepLong();
                }

                onStart() {
                    document.getElementById('body').style.backgroundColor = '#e08f8f';
                }
            }

            class Pause extends Timer {
                onTimeout() {
                    document.getElementById('statusText').innerHTML = "PAUSE";
                    document.getElementById('timeLeft').innerHTML = secondsToPresentableString(this.duration / 1000);
                    if (this.duration <= 3000) {
                        beep();
                    }
                }

                onDone() {
                    document.getElementById('timeLeft').innerHTML = "Finished";
                    beepLong();
                }

                onStart() {
                    document.getElementById('body').style.backgroundColor = '#8fe094';
                }
            }

            class Prepare extends Timer {
                onTimeout() {
                    document.getElementById('statusText').innerHTML = "PREPARE";
                    document.getElementById('timeLeft').innerHTML = secondsToPresentableString(this.duration / 1000);
                    if (this.duration <= 3000) {
                        beep();
                    }
                }

                onDone() {
                    beepLong();
                }
            }

            function secondsToPresentableString(inputSeconds) {
                var minutes = Math.floor(inputSeconds/60);
                var seconds = inputSeconds - minutes * 60;
                return zeroPrefixIfSingleDigit(minutes) + ':' + zeroPrefixIfSingleDigit(seconds);
            }

            function zeroPrefixIfSingleDigit(number) {
                if (number < 0) {
                    throw "WTF FAULTY INPUT";
                }

                if (number < 10) {
                    return "0" + number;
                } else {
                    return String(number);
                }
            }

            function beep() {
                k(volume, 440, 150);
            }

            function beepLong() {
                k(volume, 880, 300);
            }

            
            audio = new AudioContext();
            // gain, frequency, duration
            function k(w, x, y){
                console.log(w + x + y);
                v = audio.createOscillator();
                u = audio.createGain();
                v.connect(u);
                v.frequency.value = x;
                v.type = "square";
                u.connect(audio.destination);
                u.gain.value = w * 0.01;
                v.start(audio.currentTime);
                v.stop(audio.currentTime + y * 0.001);
            }

        </script>
    </body>
</html>
